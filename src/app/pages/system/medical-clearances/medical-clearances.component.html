<section class="mt-3 mt-md-5 p-2 p-md-3">
  <div class="container-fluid">
    <!-- Header with responsive button -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 mb-md-4">
      <button class="btn btn-custom-primary btn-desktop-compact" (click)="openCreateMedicalClearance()">
        <i class="bi bi-file-medical me-2"></i>Novo Atestado
      </button>
    </div>

    @if (isLoading) {
      <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2 text-muted">Carregando...</p>
      </div>
    }

    <!-- Responsive table wrapper -->
    @if (!isLoading) {
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th scope="col" class="d-none d-lg-table-cell">Aluno</th>
            <th scope="col" class="d-table-cell d-lg-none">Atestado</th>
            <th scope="col" class="d-none d-md-table-cell">Status</th>
            <th scope="col" class="d-none d-md-table-cell">Expira em</th>
            <th scope="col" class="d-none d-xl-table-cell">Criado em</th>
            <th scope="col" class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody>
          @for (clearance of medicalClearances.items!; track clearance.id) {
          <tr>
            <!-- Desktop view - full student name -->
            <td class="d-none d-lg-table-cell">
              <div>
                <strong class="text-primary">{{clearance.student?.firstName}} {{clearance.student?.lastName}}</strong>
              </div>
            </td>
            
            <!-- Mobile/Tablet view - condensed info -->
            <td class="d-table-cell d-lg-none">
              <div>
                <strong class="text-primary d-block">{{clearance.student?.firstName}} {{clearance.student?.lastName}}</strong>
                <div class="d-flex flex-wrap gap-1 mt-1">
                  <span class="badge {{getStatusBadgeClass(clearance.status)}} border">{{getStatusLabel(clearance.status)}}</span>
                  @if (clearance.isExpired) {
                    <span class="badge bg-outline-danger text-danger border">Expirado</span>
                  }
                  @if (clearance.isExpiringSoon && !clearance.isExpired) {
                    <span class="badge bg-outline-warning text-warning border">Expira em breve</span>
                  }
                </div>
                <small class="text-muted d-block mt-1">
                  <i class="bi bi-calendar-x me-1"></i>{{clearance.expiresAt | date:'dd/MM/yyyy'}}
                </small>
              </div>
            </td>
            
            <td class="d-none d-md-table-cell">
              <span class="badge {{getStatusBadgeClass(clearance.status)}} border">{{getStatusLabel(clearance.status)}}</span>
              @if (clearance.isExpired) {
                <span class="badge bg-outline-danger text-danger border ms-1">Expirado</span>
              }
              @if (clearance.isExpiringSoon && !clearance.isExpired) {
                <span class="badge bg-outline-warning text-warning border ms-1">Expira em breve</span>
              }
            </td>
            <td class="d-none d-md-table-cell">
              <small>
                <i class="bi bi-calendar-x me-1"></i>{{clearance.expiresAt | date:'dd/MM/yyyy'}}
              </small>
              @if (clearance.daysUntilExpiry !== undefined && clearance.daysUntilExpiry >= 0) {
                <small class="d-block text-muted">({{clearance.daysUntilExpiry}} dias)</small>
              }
            </td>
            <td class="d-none d-xl-table-cell">
              <small>{{clearance.createdAt | date:'dd/MM/yyyy HH:mm'}}</small>
            </td>
            <td class="text-center">
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" (click)="openUpdateMedicalClearance(clearance)" title="Editar">
                  <img src="../../../../assets/icons/structural-icons/pencil-square.svg" alt="Editar" style="width: 16px; height: 16px;" />
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="deleteMedicalClearance(clearance)" title="Excluir">
                  <img src="../../../../assets/icons/structural-icons/trash.svg" alt="Excluir" style="width: 16px; height: 16px;" />
                </button>
                <button *ngIf="clearance.hasAttachment" type="button" class="btn btn-sm btn-outline-secondary" (click)="openAttachment(clearance)" title="Visualizar Arquivo">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Empty state -->
    @if (medicalClearances.items!.length === 0) {
      <div class="text-center py-5">
        <div class="mb-3">
          <i class="bi bi-file-medical display-1 text-muted"></i>
        </div>
        <h5 class="text-muted">Nenhum atestado médico encontrado</h5>
        <p class="text-muted">Clique em "Novo Atestado" para cadastrar o primeiro atestado médico.</p>
      </div>
    }

    <!-- Pagination -->
    @if (medicalClearances.items!.length > 0) {
      <app-pagination
        [currentPage]="currentPage"
        [totalPages]="medicalClearances.totalPages ?? 1"
        [pageSize]="pageSize"
        [totalItems]="medicalClearances.totalCount ?? 0"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)">
      </app-pagination>
    }
    }
  </div>
</section>

@if(openedCreateMedicalClearance){
<app-create-medical-clearance (closeEvent)="closeCreateMedicalClearance()" (medicalClearanceCreated)="onMedicalClearanceCreated()">
</app-create-medical-clearance>
}

@if(openedUpdateMedicalClearance){
<app-update-medical-clearance [medicalClearance]="selectedMedicalClearance" (closeEvent)="closeUpdateMedicalClearance()" (medicalClearanceUpdated)="onMedicalClearanceUpdated()">
</app-update-medical-clearance>
}

<!-- Modal for viewing attachment -->
<div *ngIf="selectedAttachmentBlob" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Visualizar Atestado</h5>
        <button type="button" class="btn-close" (click)="closeAttachmentViewer()"></button>
      </div>
      <div class="modal-body">
        <app-blob-viewer [blob]="selectedAttachmentBlob" [mimeType]="selectedAttachmentMimeType"></app-blob-viewer>
      </div>
    </div>
  </div>
</div>
